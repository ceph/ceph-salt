{% set time_server = pillar['ceph-salt']['time_server']['server_host'] %}

{% if grains['fqdn'] == time_server %}
{% for server in pillar['ceph-salt']['time_server'].get('external_time_servers', []) %}
pool {{ server }} iburst
{% endfor %}

local stratum 10
manual
{% set is_ip4 = 'ip4' == pillar['ceph-salt'].get('network', {}).get('address_family', 'ip4')%}
{% set fqdn_ip = grains['fqdn_ip4' if is_ip4 else 'fqdn_ip6'] %}
{% set subnets = salt['network.subnets' if is_ip4 else 'network.subnets6'] %}
{% for subnet in subnets() %}
{% if salt['network.ip_in_subnet'](fqdn_ip, subnet) %}
allow {{ subnet }}
{% endif %}
{% endfor %}

{% else %}

server {{ time_server }} iburst
{% endif %}

driftfile /var/lib/chrony/drift
makestep 0.1 3
rtcsync
logdir /var/log/chrony
